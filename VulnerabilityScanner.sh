#!/bin/bash

# Ensure the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo "Please run the script as root."
  exit 1
fi

# Check for dependencies
check_dependency() {
  if ! command -v "$1" &> /dev/null; then
    echo "Error: $1 is not installed. Please install it and try again."
    exit 1
  fi
}

check_dependency "nmap"
check_dependency "netdiscover"
check_dependency "pv"

# Prompt for subnet range
echo "Enter the subnet range to scan (e.g., 192.168.1.0/24):"
read -r SUBNET
if [[ -z "$SUBNET" ]]; then
  echo "No subnet range provided. Exiting."
  exit 1
fi

# Discover devices
NETDISCOVER_OUTPUT=$(sudo netdiscover -r "$SUBNET" -P)
if echo "$NETDISCOVER_OUTPUT" | grep -q "XX"; then
  echo "$NETDISCOVER_OUTPUT" | awk '/^\|/{print NR-2, $2, $3, $4}' | column -t
  DEVICES=$(echo "$NETDISCOVER_OUTPUT" | awk '/^\|/{print $2}')
else
  NMAP_OUTPUT=$(sudo nmap -sn "$SUBNET")
  DEVICES=$(echo "$NMAP_OUTPUT" | grep "Nmap scan report for" | awk '{print $5}')
  if [[ -z "$DEVICES" ]]; then
    echo "No devices detected. Exiting."
    exit 1
  fi
  echo "$DEVICES" | nl
fi

if [[ -z "$DEVICES" ]]; then
  echo "No devices discovered. Exiting."
  exit 1
fi

echo "Enter the IP addresses to scan (or 'all' for all devices):"
read -r SELECTED
if [[ "$SELECTED" == "all" ]]; then
  TARGETS="$DEVICES"
else
  TARGETS=$(echo "$DEVICES" | grep -E "$(echo "$SELECTED" | sed 's/ /|/g')")
fi

if [[ -z "$TARGETS" ]]; then
  echo "No valid targets selected. Exiting."
  exit 1
fi

echo "$TARGETS" | nl

# Define ports
PORTS="21,22,23,25,53,80,111,139,445,512,513,514,1099,2049,3306,3632,5432,8009,8180"

echo "Enter the directory to store logs (default: ./scan_results):"
read -r LOG_DIR
LOG_DIR=${LOG_DIR:-./scan_results}
mkdir -p "$LOG_DIR"

# Progress bar
progress_bar() {
  local duration=$1
  for ((i = 0; i <= 100; i += 5)); do
    echo -ne "Progress: ["
    for ((j = 0; j < i; j += 5)); do echo -ne "#"; done
    for ((j = i; j < 100; j += 5)); do echo -ne "."; done
    echo -ne "] $i%\r"
    sleep $((duration / 20))
  done
  echo -ne "\n"
}

# Run scans
SUMMARY_FILE="$LOG_DIR/summary.txt"
VULNERABILITIES_FILE="$LOG_DIR/vulnerabilities_list.txt"
echo "Summary of Vulnerabilities Found" > "$SUMMARY_FILE"
echo "List of Vulnerabilities Detected" > "$VULNERABILITIES_FILE"

scan_target() {
  local name="$1"
  local script="$2"
  local output_file="$3"
  echo "Starting $name scan..."
  progress_bar 20
  nmap -p "$PORTS" --script="$script" -oN "$LOG_DIR/$output_file" $TARGETS &> /dev/null
  local count=$(grep -E "VULNERABLE|CVE|exploit" "$LOG_DIR/$output_file" | wc -l)
  echo "$name: $count vulnerabilities detected" >> "$SUMMARY_FILE"
  echo "$name: $count vulnerabilities detected"
  grep -E "VULNERABLE|CVE|exploit" "$LOG_DIR/$output_file" | awk -F':' '{print $1}' | sort -u >> "$VULNERABILITIES_FILE"
}

scan_target "Open Ports and Services" "default,safe" "open_ports_and_services.txt"
scan_target "Web Vulnerabilities" "http-vuln*,http-enum,http-sql-injection,http-xss" "web_vulnerabilities.txt"
scan_target "Network Vulnerabilities" "vuln" "network_vulnerabilities.txt"
scan_target "SSL/TLS Vulnerabilities" "ssl-enum-ciphers,ssl-cert" "ssl_tls_vulnerabilities.txt"
scan_target "Brute Force Vulnerabilities" "brute" "brute_force_vulnerabilities.txt"
scan_target "Exploitable Services" "exploit" "exploitable_services.txt"
scan_target "SMB Vulnerabilities" "smb-vuln-*" "smb_vulnerabilities.txt"

echo "Scan completed. Logs saved in $LOG_DIR."
echo "Summary: $SUMMARY_FILE"
echo "Vulnerabilities: $VULNERABILITIES_FILE"
